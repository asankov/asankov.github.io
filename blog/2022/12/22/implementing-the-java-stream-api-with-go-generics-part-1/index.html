<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.108.0"><link rel=canonical href=https://asankov.dev/blog/2022/12/22/implementing-the-java-stream-api-with-go-generics-part-1/><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Implementing the Java Stream API with Go Generics: Part 1 | Anton Sankov's Blog</title><meta name=description content="The Java Stream API is a flexible API that allows you to use functional programming to manipulate data. Since Go 1.18 when generics were introduced to the language it is much easier to do something similar in Go. This port follows my experience implementing the Stream API in Go with generics.
"><meta property="og:title" content="Implementing the Java Stream API with Go Generics: Part 1"><meta property="og:description" content="The Java Stream API is a flexible API that allows you to use functional programming to manipulate data. Since Go 1.18 when generics were introduced to the language it is much easier to do something similar in Go. This port follows my experience implementing the Stream API in Go with generics.
"><meta property="og:type" content="article"><meta property="og:url" content="https://asankov.dev/blog/2022/12/22/implementing-the-java-stream-api-with-go-generics-part-1/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-12-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-22T14:45:22+02:00"><meta property="og:site_name" content="Anton Sankov's Blog"><meta itemprop=name content="Implementing the Java Stream API with Go Generics: Part 1"><meta itemprop=description content="The Java Stream API is a flexible API that allows you to use functional programming to manipulate data. Since Go 1.18 when generics were introduced to the language it is much easier to do something similar in Go. This port follows my experience implementing the Stream API in Go with generics.
"><meta itemprop=datePublished content="2022-12-22T00:00:00+00:00"><meta itemprop=dateModified content="2022-12-22T14:45:22+02:00"><meta itemprop=wordCount content="2418"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementing the Java Stream API with Go Generics: Part 1"><meta name=twitter:description content="The Java Stream API is a flexible API that allows you to use functional programming to manipulate data. Since Go 1.18 when generics were introduced to the language it is much easier to do something similar in Go. This port follows my experience implementing the Stream API in Go with generics.
"><link rel=preload href=/scss/main.min.c63ef944d5a6d9753d4701f75bc18252579cfb09e955d758ae1b0f412ebf256d.css as=style><link href=/scss/main.min.c63ef944d5a6d9753d4701f75bc18252579cfb09e955d758ae1b0f412ebf256d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7Y9WXX1393"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7Y9WXX1393",{anonymize_ip:!1})}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" style=position:relative><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold text-nord5">Anton Sankov's Blog</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About Me</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Anton Sankov's Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221222implementing-the-java-stream-api-with-go-generics-part-1-li><a href=/blog/2022/12/22/implementing-the-java-stream-api-with-go-generics-part-1/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20221222implementing-the-java-stream-api-with-go-generics-part-1><span class=td-sidebar-nav-active-item>Implementing the Java Stream API with Go Generics: Part 1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220711demystifying-the-kubernetes-iceberg-part-8-li><a href=/blog/2022/07/11/demystifying-the-kubernetes-iceberg-part-8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220711demystifying-the-kubernetes-iceberg-part-8><span>Demystifying the Kubernetes Iceberg: Part 8</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220704demystifying-the-kubernetes-iceberg-part-7-li><a href=/blog/2022/07/04/demystifying-the-kubernetes-iceberg-part-7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220704demystifying-the-kubernetes-iceberg-part-7><span>Demystifying the Kubernetes Iceberg: Part 7</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220627demystifying-the-kubernetes-iceberg-part-6-li><a href=/blog/2022/06/27/demystifying-the-kubernetes-iceberg-part-6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220627demystifying-the-kubernetes-iceberg-part-6><span>Demystifying the Kubernetes Iceberg: Part 6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220612demystifying-the-kubernetes-iceberg-part-5-li><a href=/blog/2022/06/12/demystifying-the-kubernetes-iceberg-part-5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220612demystifying-the-kubernetes-iceberg-part-5><span>Demystifying the Kubernetes Iceberg: Part 5</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220605demystifying-the-kubernetes-iceberg-part-4-li><a href=/blog/2022/06/05/demystifying-the-kubernetes-iceberg-part-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220605demystifying-the-kubernetes-iceberg-part-4><span>Demystifying the Kubernetes Iceberg: Part 4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220529demystifying-the-kubernetes-iceberg-part-3-li><a href=/blog/2022/05/29/demystifying-the-kubernetes-iceberg-part-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220529demystifying-the-kubernetes-iceberg-part-3><span>Demystifying the Kubernetes Iceberg: Part 3</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220522demystifying-the-kubernetes-iceberg-part-2-li><a href=/blog/2022/05/22/demystifying-the-kubernetes-iceberg-part-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220522demystifying-the-kubernetes-iceberg-part-2><span>Demystifying the Kubernetes Iceberg: Part 2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220515demystifying-the-kubernetes-iceberg-part-1-li><a href=/blog/2022/05/15/demystifying-the-kubernetes-iceberg-part-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220515demystifying-the-kubernetes-iceberg-part-1><span>Demystifying the Kubernetes Iceberg: Part 1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220421securing-kubernetes-with-open-policy-agent-li><a href=/blog/2022/04/21/securing-kubernetes-with-open-policy-agent/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220421securing-kubernetes-with-open-policy-agent><span>Securing Kubernetes with Open Policy Agent</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220129different-ways-to-initialize-go-structs-li><a href=/blog/2022/01/29/different-ways-to-initialize-go-structs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220129different-ways-to-initialize-go-structs><span>Different Ways to Initialize Go structs</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#defining-the-interface>Defining the interface</a><ul><li><a href=#function-names-capitalization>Function names capitalization</a></li><li><a href=#no-function-overloads-in-go>No function overloads in Go</a></li><li><a href=#methods-that-cannot-be-part-of-the-interface>Methods that cannot be part of the interface</a></li><li><a href=#methods-that-cannot-be-implemented-due-to-constraints>Methods that cannot be implemented due to constraints</a></li><li><a href=#static-methods>Static methods</a></li></ul></li><li><a href=#initial-implementation>Initial implementation</a></li><li><a href=#using-the-stream>Using the Stream</a></li><li><a href=#unit-testing-the-code>Unit-testing the code</a></li><li><a href=#leftovers-and-next-steps>Leftovers and next steps</a><ul><li><a href=#lack-of-parallel-operations>Lack of parallel operations</a></li><li><a href=#missing-iterator-and-spliterator>Missing Iterator and Spliterator</a></li><li><a href=#lack-of-terminal-operations>Lack of terminal operations</a></li><li><a href=#lack-of-lazy-evaluation>Lack of lazy evaluation</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://asankov.dev/categories/gatekeeper/ data-taxonomy-term=gatekeeper><span class=taxonomy-label>Gatekeeper</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/go/ data-taxonomy-term=go><span class=taxonomy-label>Go</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>Kubernetes</span><span class=taxonomy-count>9</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/open-policy-agent/ data-taxonomy-term=open-policy-agent><span class=taxonomy-label>Open Policy Agent</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/security/ data-taxonomy-term=security><span class=taxonomy-label>Security</span><span class=taxonomy-count>2</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Implementing the Java Stream API with Go Generics: Part 1</h1><div class=lead>The Java Stream API is a flexible API that allows you to use functional programming to manipulate data. Since Go 1.18 when generics were introduced to the language it is much easier to do something similar in Go. This port follows my experience implementing the Stream API in Go with generics.</div><div class="td-byline mb-4"><time datetime=2022-12-22 class=text-muted>Thursday, December 22, 2022</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://asankov.dev/categories/go/ data-taxonomy-term=go><span class=taxonomy-label>Go</span></a></li></ul></div><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 12 minute read &nbsp;</p></header><p>A long time ago in a galaxy far, far away&mldr;
Okay, it was in the same galaxy, but a long time ago I used to be a Java developer.</p><p>That is before I moved to working with Go full-time when I joined Docker in 2019.</p><p>In my Java days, one of my favourite Java APIs was the Stream API.
This is a set of APIs that allow you to work with data structures such as lists in a way that resembles functional programming.</p><p>For example, this code creates a new <code>Stream</code> with values of 1 to 5.
It then maps the values by multiplying each one by <code>2</code> and, in the end, calls the <code>System.out.println</code> method for each of the values.</p><p>Running this code will print the values <code>2, 4, 6, 8, 10</code> to the screen.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Stream<span style=color:#719e07>.</span>of<span style=color:#719e07>(</span><span style=color:#2aa198>1</span><span style=color:#719e07>,</span> <span style=color:#2aa198>2</span><span style=color:#719e07>,</span> <span style=color:#2aa198>3</span><span style=color:#719e07>,</span> <span style=color:#2aa198>4</span><span style=color:#719e07>,</span> <span style=color:#2aa198>5</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>.</span>map<span style=color:#719e07>(</span>i <span style=color:#719e07>-&gt;</span> i <span style=color:#719e07>*</span> <span style=color:#2aa198>2</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>    <span style=color:#719e07>.</span>forEach<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>out<span style=color:#719e07>::</span>println<span style=color:#719e07>)</span>
</span></span></code></pre></div><p>This style of programming is loved by many (me included) for multiple reasons:</p><ul><li>it allows modifying data in an easy, human-readable manner</li><li>it hides complex operations behind a simple API.
We can easily change the implementation without changing the code
(for example, by calling the <code>parallel</code> method of the <code>Stream</code> object that converts the stream to a parallel one)</li><li>it utilizes functional-programming patterns (like immutability and pure functions)</li></ul><p>Implementing such an API was not impossible in <a href=https://go.dev/blog/intro-generics>Go before 1.18</a>, but because of the lack of generics, it would have meant that we needed to implement this API each time for each different type.
Not ideal.</p><p>Generics solve this problem, and it is precisely in use cases like this that their benefit is visible.</p><p>So I decided that I am going to re-implement this API in Go.</p><h2 id=defining-the-interface>Defining the interface</h2><p>Before starting the implementation, I first had to define the interface.</p><p>To do that, I copied the <code>Stream</code> interface from <a href=https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html>here</a> and used it as a baseline.</p><p>Most of the rewriting of the interface from Java to Go was straightforward, but not everything.</p><p>Of course, the Java and Go languages have some differences between them.
That meant that I had to make some minor changes to the interface for it to be usable in Go.</p><p>These are the changes:</p><h3 id=function-names-capitalization>Function names capitalization</h3><p>The most obvious one is that I had to capitalize all method names (<code>forEach</code> → <code>ForEach</code>, etc.).
That is because, in Go, all public identifiers start with a capital letter.
Defining a private interface method makes no sense; hence I needed this change.</p><h3 id=no-function-overloads-in-go>No function overloads in Go</h3><p>Another change I had to make was renaming methods with the same name.
In the Java interface, there are methods like <code>sorted</code>, <code>collect</code>and <code>reduce</code> that have overloads based on the type and number of arguments they are invoked with.</p><p>Go does not support function overloads, so I had to define these methods with different names.
Full list of these name changes:</p><ul><li><code>reduce(BinaryOperator&lt;T> accumulator)</code> → <code>Reduce</code></li><li><code>reduce(T identity, BinaryOperator&lt;T> accumulator)</code> → <code>ReduceWithIdentity</code></li><li><code>reduce(U identity, BiFunction&lt;U,? super T,U> accumulator, BinaryOperator&lt;U> combiner)</code>-> <code>ReduceWithIdentityAndCombiner</code></li><li><code>sorted()</code> → <code>Sorted</code></li><li><code>sorted(Comparator&lt;? super T> comparator)</code> → <code>SortedWithComparator</code></li><li><code>collect(Supplier&lt;R> supplier, BiConsumer&lt;R,? super T> accumulator, BiConsumer&lt;R,R> combiner)</code> → <code>Collect</code></li><li><code>collect(Collector&lt;? super T,A,R> collector)</code> → <code>CollectWithCollector</code></li></ul><p>I have also decided to omit some methods from the Go interface.
For example, in Java, we have <code>(flat)mapToInt</code> and <code>(flat)mapToLong</code>, which return <code>IntStream/Int</code> and <code>LongStream/Long</code>.
I have decided to keep only <code>(flat)mapToInt</code> which returns a stream of <code>int64</code> (or just an <code>int64</code>).
Go does not have a type like <code>long</code>; instead, we use <code>int64</code>; hence the second method is not really needed.
(I could have made <code>MapToInt(...) int32</code> and <code>MapToLong(...) int64</code>, but I think that is not needed unless you care that much about memory usage.</p><p>Another difference is that the Java interface defines two <code>toArray</code> methods.
One that receives no arguments and returns an <code>Object[]</code> (hence erasing the original generic type), and one that receives an array generator and returns an array of the same type (hence saving the original generic type).
That is because Java generics are just compile-type checks, and all generic information is erased at runtime.
This is not the case in Go, and we do not need to receive an array generator to be able to preserve the original generic type.
So I have only defined one <code>ToArray</code> method that receives no arguments and returns a <code>T[]</code> (where <code>T</code> is the original generic type, hence preserving the original generic type).</p><h3 id=methods-that-cannot-be-part-of-the-interface>Methods that cannot be part of the interface</h3><p>Due to a limitation in the Go implementation of generics, some of the methods that are part of the Java <code>Stream</code> interface cannot be part of the Go interface.</p><p>These methods are:</p><ul><li><code>map(Function&lt;? super T,? extends R> mapper)</code></li><li><code>&lt;R> Stream&lt;R> flatMap(Function&lt;? super T,? extends Stream&lt;? extends R>> mapper)</code></li><li><code>&lt;R> R collect(Supplier&lt;R> supplier, BiConsumer&lt;R,? super T> accumulator, BiConsumer&lt;R,R> combiner)</code></li><li><code>&lt;R,A> R collect(Collector&lt;? super T,A,R> collector)</code></li><li><code>&lt;U> U reduce(U identity, BiFunction&lt;U,? super T,U> accumulator, BinaryOperator&lt;U> combiner)</code></li></ul><p>The reason for that is these methods operator not only with the type of the Stream (<code>T</code>), but with one or two more generic types (<code>R</code>, <code>U</code>, <code>A</code>).
Go does not allow attaching generic parameters to an interface methods, so something like this is not valid Go code:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>type</span> Stream[T any] <span style=color:#268bd2>interface</span> {
</span></span><span style=display:flex><span>    Map[R any](mapper <span style=color:#268bd2>func</span>(T) R) <span style=color:#586e75>// ❌ compile-time error: interface method must have no type parameters
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><p>This means that we cannot have these methods on the interface type.</p><p>The solution I came up with is to extract these methods as package methods of the <code>stream</code> package and make the stream the first argument:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#719e07>package</span> stream
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>func</span> Map[T any, R any](stream Stream[T], mapper <span style=color:#268bd2>func</span>(T) R) Stream[R]
</span></span></code></pre></div><p>This will allow us to implement the same functionality in a similar way, with the only drawback that in the implementation of <code>Map</code> (and the other functions in this group) we will not be able to use any of the internal of the current stream implementation, but would have to only use the interface methods.
I think that should be ok.</p><h3 id=methods-that-cannot-be-implemented-due-to-constraints>Methods that cannot be implemented due to constraints</h3><p>Generics in Go have something called a constraint.
That is the minimum type that can be passed to the generic function/struct.</p><p>The most broad constraint is <code>any</code>, which is an alias for <code>interface{}</code>.
This constraint means that we can use every type with this generic function/struct, but it also limit what we can do with the value.</p><p>For example, we can do:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> Do[T any](t T) T{
</span></span><span style=display:flex><span>    <span style=color:#719e07>return</span> t
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>but we cannot do:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>func</span> Do[T any](t1, t2 T) T {
</span></span><span style=display:flex><span>     <span style=color:#719e07>return</span> t1 <span style=color:#719e07>+</span> t2 <span style=color:#586e75>// ❌ compile-time error: invalid operation: operator + not defined on t1 (variable of type T constrained by any)
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>}
</span></span></code></pre></div><p>that is because Go does not know whether the <code>+</code> operation will be defined on the type that we use with this generic function.</p><p>If we want to be able to do something with the values we need to use more restrictive constraint.</p><p>The Go package <a href=http://golang.org/x/exp/constraints><code>golang.org/x/exp/constraints</code></a> defines useful constraints like <code>Integer</code>, <code>Float</code>, etc.
We can use these if we want to do arithmetic operations with our values.</p><p>We can use any interface as a constraint.</p><p>As constraint for my <code>Stream</code> interface I picked <code>any</code> because I want to be used with as many types with possible.
However, that means that some methods cannot be implemented.
These are the <code>Sorted()</code> method and <code>Distinct()</code> methods.
In Java they can be implemented for any type, because Java type inherits from <code>Object</code> and it has <code>equals</code> methods that can be used to compare the values.
In Go, that is simple not possible.
That is why, for my initial implementation I have left these methods non-implemented and if called they will <code>panic</code>.
For sorting there is the <code>SortedWithComparator</code> function that required the consumer pass a comparator, which will be used for the sorting.</p><h3 id=static-methods>Static methods</h3><p>The Java <code>Stream</code> interface has some static methods attached to him.
These include <code>Stream.of</code> , <code>Stream.generate</code>, <code>Stream.iterate</code>, etc.
Go does not have static methods, but does have package methods not attached to the type, so we can use that for these methods.
That way the usage of these methods in Java and Go will look similar:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var s <span style=color:#719e07>=</span> Stream<span style=color:#719e07>.</span>of<span style=color:#719e07>(</span><span style=color:#2aa198>1</span><span style=color:#719e07>,</span> <span style=color:#2aa198>2</span><span style=color:#719e07>,</span> <span style=color:#2aa198>3</span><span style=color:#719e07>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#719e07>import</span> <span style=color:#2aa198>&#34;github.com/asankov/go-streams/stream&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>var</span> s = stream.<span style=color:#268bd2>Of</span>(<span style=color:#2aa198>1</span>, <span style=color:#2aa198>2</span>, <span style=color:#2aa198>3</span>)
</span></span></code></pre></div><h2 id=initial-implementation>Initial implementation</h2><p>I wanted to make the initial implementation as simple as possible.</p><p>I decided that the way to do that is to have a generic struct with a slice of generic elements.
These will be the elements of the stream.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#268bd2>type</span> SliceStream[T any] <span style=color:#268bd2>struct</span> {
</span></span><span style=display:flex><span>    elements []T
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The type constraint for the generic type <code>T</code> is <code>any</code> because we want to allow this struct to be used with any type (more on the limitation that comes from this decision later).</p><p>The <code>elements</code> slice is a private property of the struct.
We do not want anyone to mess with the elements from the outside.
Instead, we want the consumers of this struct to interact with it via the Stream API (also, the implementation can change later, and we can replace the slice with something different).</p><p>Once we have the struct and interface defined, we can proceed to implement the methods.</p><p>A lot of the methods were quite simple and don’t need any explanation.
You can see all the code <a href=https://github.com/asankov/go-streams>here</a>.
Each method is documented, and it also points to the Java alternative.</p><p>Most of the methods like <code>ForEach</code>, <code>AnyMatch</code>, etc.
just iterate over the slice of elements and do the respective action for each element.</p><h2 id=using-the-stream>Using the Stream</h2><p>Now that we have the Stream implemented let&rsquo;s write some fancy code.</p><p>We are going to implement the same example I wrote in Java in the beginning of this post.</p><p>To constuct a stream use the <code>Of</code> or <code>OfSingle</code> methods of the <code>stream</code> package.
This will return an instance of <code>SliceStream</code> with the data we provided.
(Since <code>SliceStream</code> is the only existent implementation of <code>Stream</code> so far, in the future these methods could return a different implementation.)</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#719e07>import</span> <span style=color:#2aa198>&#34;github.com/asankov/go-streams/stream&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s <span style=color:#719e07>:=</span> stream.<span style=color:#268bd2>Of</span>(<span style=color:#2aa198>1</span>, <span style=color:#2aa198>2</span>, <span style=color:#2aa198>3</span>, <span style=color:#2aa198>4</span>, <span style=color:#2aa198>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#268bd2>Map</span>(s, <span style=color:#268bd2>func</span>(i <span style=color:#dc322f>int</span>) <span style=color:#dc322f>int</span> { <span style=color:#719e07>return</span> i <span style=color:#719e07>*</span> <span style=color:#2aa198>2</span>}).
</span></span><span style=display:flex><span>    <span style=color:#268bd2>ForEach</span>(fmt.Println)
</span></span></code></pre></div><p>This code creates a <code>Stream</code> with the values <code>[1, 2, 3, 4, 5]</code>.</p><p>In the then <code>Map</code>s each value by multiplying it by 2.
The values are now <code>[2, 4, 6, 8, 10]</code></p><p>In the end, for each element of the stream it calls <code>fmt.Println</code>.</p><p>After running this code, we are going to see this output in the console:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>2
</span></span><span style=display:flex><span>4
</span></span><span style=display:flex><span>6
</span></span><span style=display:flex><span>8
</span></span><span style=display:flex><span>10
</span></span></code></pre></div><p>Of course, there are many more functions in the package, so you can download it and experiment with it.
To do so, run:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>go get github.com/asankov/go-streams
</span></span></code></pre></div><p>and get started!</p><h2 id=unit-testing-the-code>Unit-testing the code</h2><p>Along with the first slice-based implementation I also wrote a unit-test suite that covers >90% of the code.</p><p>Most of the tests are in this <a href=https://github.com/asankov/go-streams/blob/main/stream/slice_stream_test.go>file</a> with more test files in the same directory.</p><h2 id=leftovers-and-next-steps>Leftovers and next steps</h2><p>There are still some leftovers I would like to resolve at some point.</p><h3 id=lack-of-parallel-operations>Lack of parallel operations</h3><p>For example, right now the <code>Parallel</code> function of the <code>SliceStream</code> does not do anything, because the slice stream operations cannot be executed in parallel.
That is because, the slice is not a thread-safe data structure.
In order to implement thread-safe parallel operations I would need to use something like a channel to hold the data.
That should not be that hard and I plan to implement it in the near future.</p><p>Non-parallel execution of the operations also means that the <code>combiner</code> function in <code>Collect</code> and <code>ReduceWithIdentityAndCombiner</code> is not used for anything.
I also plan to correct that in the next implementation.</p><h3 id=missing-iterator-and-spliterator>Missing Iterator and Spliterator</h3><p>Also, I have not implemented the <code>Iterator</code> and <code>Spliterator</code> methods, because these including implementing additional data-structures.
Again, I plan to do that next.</p><h3 id=lack-of-terminal-operations>Lack of terminal operations</h3><p>In Java, a <code>Stream</code> can be read only once.
If you have a <code>Stream</code> and call a method like <code>forEach</code> it will do the operation you called <code>forEach</code> with and the <code>Stream</code> will be consumed.
Trying to call <code>forEach</code> a second time will throw an Exception that the <code>Stream</code> has already been consumed.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var stream <span style=color:#719e07>=</span> Stream<span style=color:#719e07>.</span>of<span style=color:#719e07>(</span><span style=color:#2aa198>1</span><span style=color:#719e07>,</span> <span style=color:#2aa198>2</span><span style=color:#719e07>,</span> <span style=color:#2aa198>3</span><span style=color:#719e07>,</span> <span style=color:#2aa198>4</span><span style=color:#719e07>,</span> <span style=color:#2aa198>5</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>stream<span style=color:#719e07>.</span>forEach<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>out<span style=color:#719e07>::</span>println<span style=color:#719e07>)</span> <span style=color:#586e75>// this line will print all values to the console
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span>stream<span style=color:#719e07>.</span>forEach<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>out<span style=color:#719e07>::</span>println<span style=color:#719e07>)</span> <span style=color:#586e75>// ❌ java.lang.IllegalStateException: stream has already been operated upon or closed
</span></span></span></code></pre></div><p>This is because <code>forEach</code> is something called terminal operation which consumes the <code>Stream</code>, which is no longer usable at that point.</p><p>I have not added this in my implementation (so far).</p><h3 id=lack-of-lazy-evaluation>Lack of lazy evaluation</h3><p>Another really good thing about <code>Streams</code> is that the operations you perform are lazily-evaluated.</p><p>That means that if you perform something like <code>Map</code> without actually consuming the value (for example with <code>ForEach</code> or <code>FindAny</code>) the Map operation will not be evaluated.
It will be evaluated only when we try to consume it.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>var stream <span style=color:#719e07>=</span> Stream<span style=color:#719e07>.</span>of<span style=color:#719e07>(</span><span style=color:#2aa198>1</span><span style=color:#719e07>,</span> <span style=color:#2aa198>2</span><span style=color:#719e07>,</span> <span style=color:#2aa198>3</span><span style=color:#719e07>,</span> <span style=color:#2aa198>4</span><span style=color:#719e07>,</span> <span style=color:#2aa198>5</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>stream <span style=color:#719e07>=</span> stream<span style=color:#719e07>.</span>map<span style=color:#719e07>(</span>i <span style=color:#719e07>-&gt;</span> i <span style=color:#719e07>*</span> <span style=color:#2aa198>2</span><span style=color:#719e07>)</span> <span style=color:#586e75>// this is not yet evaluated
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>
</span></span><span style=display:flex><span>stream<span style=color:#719e07>.</span>forEach<span style=color:#719e07>(</span>System<span style=color:#719e07>.</span>out<span style=color:#719e07>::</span>println<span style=color:#719e07>)</span> <span style=color:#586e75>// the map operation will only be evaluated once we get to here
</span></span></span></code></pre></div><p>This brings some performance benefits, because it means that if you accidentally forget to consume the stream all the operations you did with it before will be actually no-ops and won&rsquo;t waste any CPU time.</p><p>This is another thing that is missing from my implementation.</p><h2 id=summary>Summary</h2><p>Go 1.18 introduced a big change in the language <a href=https://go.dev/blog/intro-generics>adding support for type-parameters</a>.</p><p>This made it more easy to implement generic data-structures like Streams.</p><p>Particularly for Stream, this does not feel like the most Go-like way of working with data.</p><p>Indeed, functions are first-class citizens in Go and functional-like programming has always been possible in Go.
But they way functions are passed around in Go is much more verbose that the way to do it in Java:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>s.<span style=color:#268bd2>Map</span>(<span style=color:#268bd2>func</span>(i <span style=color:#dc322f>int</span>) <span style=color:#dc322f>string</span> { <span style=color:#719e07>return</span> <span style=color:#2aa198>&#34;(&#34;</span> <span style=color:#719e07>+</span> i <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;)&#34;</span> })
</span></span></code></pre></div><p>is much more verbose and clunky than:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>s<span style=color:#719e07>.</span>map<span style=color:#719e07>(</span>i <span style=color:#719e07>-&gt;</span> <span style=color:#2aa198>&#34;(&#34;</span> <span style=color:#719e07>+</span> i <span style=color:#719e07>+</span> <span style=color:#2aa198>&#34;)&#34;</span><span style=color:#719e07>)</span>
</span></span></code></pre></div><p>because of the necessary <code>func</code> and <code>return</code> keyword, and need to specify both the arguments and return types (even though they can be inferred.)</p><p>Even though, I had a good fun implementing this and finally did something practical with generics (which I was eager to come, having been used to them in my Java time) I don&rsquo;t think that such data structure will be used by many Go programmers (me included) because of the things listen above.</p><p>Nevertheless, I still intent to fix all left-overs I outlined in the previous paragraph and have even more fun doing it, so stay tuned for Part 2.</p><p>Until then, Merry Christmas and a Happy New Year! 🎅</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/07/11/demystifying-the-kubernetes-iceberg-part-8/ aria-label="Previous - Demystifying the Kubernetes Iceberg: Part 8" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a class="btn btn-primary disabled">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="py-5 row d-print-none bg-nord0"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=mailto:asankov96@gmail.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/a_sankov aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/asankov aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel=noopener href=https://linkedin.com/in/asankov aria-label=LinkedIn><i class="fab fa-linkedin"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 Anton Sankov All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small><p class=mt-2><a href=/about/>About Me</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.1f7a9a77f4986d1b3c8c9d4e576bc7675ba7359139a0f97729bd28e9e2e1fd49.js integrity="sha256-H3qad/SYbRs8jJ1OV2vHZ1unNZE5oPl3Kb0o6eLh/Uk=" crossorigin=anonymous></script></body></html>