<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.110.0"><link rel=canonical href=https://asankov.dev/blog/2022/04/21/securing-kubernetes-with-open-policy-agent/><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Securing Kubernetes with Open Policy Agent | Anton Sankov's Blog</title><meta name=description content="Build-in Kubernetes security is not enough for most organizations to enforce granular rules and policies to the workloads running in their clusters. That is why projects like OPA and Gatekeeper exist to help you achieve a higher level of Kubernetes security
"><meta property="og:title" content="Securing Kubernetes with Open Policy Agent"><meta property="og:description" content="Build-in Kubernetes security is not enough for most organizations to enforce granular rules and policies to the workloads running in their clusters. That is why projects like OPA and Gatekeeper exist to help you achieve a higher level of Kubernetes security
"><meta property="og:type" content="article"><meta property="og:url" content="https://asankov.dev/blog/2022/04/21/securing-kubernetes-with-open-policy-agent/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-04-21T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-19T09:45:31+02:00"><meta property="og:site_name" content="Anton Sankov's Blog"><meta itemprop=name content="Securing Kubernetes with Open Policy Agent"><meta itemprop=description content="Build-in Kubernetes security is not enough for most organizations to enforce granular rules and policies to the workloads running in their clusters. That is why projects like OPA and Gatekeeper exist to help you achieve a higher level of Kubernetes security
"><meta itemprop=datePublished content="2022-04-21T00:00:00+00:00"><meta itemprop=dateModified content="2022-06-19T09:45:31+02:00"><meta itemprop=wordCount content="1889"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Securing Kubernetes with Open Policy Agent"><meta name=twitter:description content="Build-in Kubernetes security is not enough for most organizations to enforce granular rules and policies to the workloads running in their clusters. That is why projects like OPA and Gatekeeper exist to help you achieve a higher level of Kubernetes security
"><link rel=preload href=/scss/main.min.c63ef944d5a6d9753d4701f75bc18252579cfb09e955d758ae1b0f412ebf256d.css as=style><link href=/scss/main.min.c63ef944d5a6d9753d4701f75bc18252579cfb09e955d758ae1b0f412ebf256d.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7Y9WXX1393"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7Y9WXX1393",{anonymize_ip:!1})}</script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" style=position:relative><a class=navbar-brand href=/><span class=navbar-logo></span><span class="text-uppercase font-weight-bold text-nord5">Anton Sankov's Blog</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About Me</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ title="Anton Sankov's Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>Blog</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog2023011390daysofdevops-continuous-build-integration-and-testing-li><a href=/blog/2023/01/13/90daysofdevops-continuous-build-integration-and-testing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog2023011390daysofdevops-continuous-build-integration-and-testing><span>90DaysOfDevOps - Continuous Build, Integration and Testing</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20221222implementing-the-java-stream-api-with-go-generics-part-1-li><a href=/blog/2022/12/22/implementing-the-java-stream-api-with-go-generics-part-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20221222implementing-the-java-stream-api-with-go-generics-part-1><span>Implementing the Java Stream API with Go Generics: Part 1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220711demystifying-the-kubernetes-iceberg-part-8-li><a href=/blog/2022/07/11/demystifying-the-kubernetes-iceberg-part-8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220711demystifying-the-kubernetes-iceberg-part-8><span>Demystifying the Kubernetes Iceberg: Part 8</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220704demystifying-the-kubernetes-iceberg-part-7-li><a href=/blog/2022/07/04/demystifying-the-kubernetes-iceberg-part-7/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220704demystifying-the-kubernetes-iceberg-part-7><span>Demystifying the Kubernetes Iceberg: Part 7</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220627demystifying-the-kubernetes-iceberg-part-6-li><a href=/blog/2022/06/27/demystifying-the-kubernetes-iceberg-part-6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220627demystifying-the-kubernetes-iceberg-part-6><span>Demystifying the Kubernetes Iceberg: Part 6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220612demystifying-the-kubernetes-iceberg-part-5-li><a href=/blog/2022/06/12/demystifying-the-kubernetes-iceberg-part-5/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220612demystifying-the-kubernetes-iceberg-part-5><span>Demystifying the Kubernetes Iceberg: Part 5</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220605demystifying-the-kubernetes-iceberg-part-4-li><a href=/blog/2022/06/05/demystifying-the-kubernetes-iceberg-part-4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220605demystifying-the-kubernetes-iceberg-part-4><span>Demystifying the Kubernetes Iceberg: Part 4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220529demystifying-the-kubernetes-iceberg-part-3-li><a href=/blog/2022/05/29/demystifying-the-kubernetes-iceberg-part-3/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220529demystifying-the-kubernetes-iceberg-part-3><span>Demystifying the Kubernetes Iceberg: Part 3</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220522demystifying-the-kubernetes-iceberg-part-2-li><a href=/blog/2022/05/22/demystifying-the-kubernetes-iceberg-part-2/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220522demystifying-the-kubernetes-iceberg-part-2><span>Demystifying the Kubernetes Iceberg: Part 2</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220515demystifying-the-kubernetes-iceberg-part-1-li><a href=/blog/2022/05/15/demystifying-the-kubernetes-iceberg-part-1/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220515demystifying-the-kubernetes-iceberg-part-1><span>Demystifying the Kubernetes Iceberg: Part 1</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220421securing-kubernetes-with-open-policy-agent-li><a href=/blog/2022/04/21/securing-kubernetes-with-open-policy-agent/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20220421securing-kubernetes-with-open-policy-agent><span class=td-sidebar-nav-active-item>Securing Kubernetes with Open Policy Agent</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220129different-ways-to-initialize-go-structs-li><a href=/blog/2022/01/29/different-ways-to-initialize-go-structs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220129different-ways-to-initialize-go-structs><span>Different Ways to Initialize Go structs</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#build-in-kubernetes-security-rbac>Build-in Kubernetes Security (RBAC)</a></li><li><a href=#why-rbac-is-not-enough>Why RBAC is not enough</a></li><li><a href=#beyond-rbac>Beyond RBAC</a></li><li><a href=#open-policy-agent>Open Policy Agent</a></li><li><a href=#rego>Rego</a></li><li><a href=#gatekeeper>Gatekeeper</a><ul><li><a href=#constrainttemplates>ConstraintTemplates</a></li><li><a href=#constraint>Constraint</a></li><li><a href=#getting-our-hands-dirty>Getting our hands dirty</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div><div class="taxonomy taxonomy-terms-cloud taxo-categories"><h5 class=taxonomy-title>Categories</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://asankov.dev/categories/devops/ data-taxonomy-term=devops><span class=taxonomy-label>DevOps</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/gatekeeper/ data-taxonomy-term=gatekeeper><span class=taxonomy-label>Gatekeeper</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/go/ data-taxonomy-term=go><span class=taxonomy-label>Go</span><span class=taxonomy-count>2</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>Kubernetes</span><span class=taxonomy-count>9</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/open-policy-agent/ data-taxonomy-term=open-policy-agent><span class=taxonomy-label>Open Policy Agent</span><span class=taxonomy-count>1</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/security/ data-taxonomy-term=security><span class=taxonomy-label>Security</span><span class=taxonomy-count>2</span></a></li></ul></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Securing Kubernetes with Open Policy Agent</h1><div class=lead>Build-in Kubernetes security is not enough for most organizations to enforce granular rules and policies to the workloads running in their clusters. That is why projects like OPA and Gatekeeper exist to help you achieve a higher level of Kubernetes security</div><div class="td-byline mb-4"><time datetime=2022-04-21 class=text-muted>Thursday, April 21, 2022</time></div><header class=article-meta><div class="taxonomy taxonomy-terms-article taxo-categories"><h5 class=taxonomy-title>Categories:</h5><ul class=taxonomy-terms><li><a class=taxonomy-term href=https://asankov.dev/categories/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>Kubernetes</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/open-policy-agent/ data-taxonomy-term=open-policy-agent><span class=taxonomy-label>Open Policy Agent</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/gatekeeper/ data-taxonomy-term=gatekeeper><span class=taxonomy-label>Gatekeeper</span></a></li><li><a class=taxonomy-term href=https://asankov.dev/categories/security/ data-taxonomy-term=security><span class=taxonomy-label>Security</span></a></li></ul></div><p class=reading-time><i class="fa fa-clock" aria-hidden=true></i>&nbsp; 9 minute read &nbsp;</p></header><p>Over the past 8 years, Kubernetes became the de-facto standard for deploying and managing containerized applications.
This requires that the platform on which we build our apps (Kubernetes) be just as secure as our applications.</p><p>Kubernetes gives you some security out-of-the-box and it also gives you methods for extending that yourself.
Let&rsquo;s see what these are.</p><h2 id=build-in-kubernetes-security-rbac>Build-in Kubernetes Security (RBAC)</h2><p>What you get out of the box with Kubernetes is an <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac/>RBAC (Role-Based Action Control)</a> mechanism, which allows you to define roles that can perform certain actions on the Kubernetes resources.
For example, you can define a <code>Developer</code> role that can <code>Get/List Deployments</code> and a <code>DevOps</code> role that can additionally <code>Create/Update Deployments</code>.</p><h2 id=why-rbac-is-not-enough>Why RBAC is not enough</h2><p>Usually, that is not enough for most Kubernetes users.
The reason is that most organizations that use Kubernetes want to enforce more granular rules on their resources.
For example, they want to enforce that only images from trusted repositories are used as the base for Deployments, or that all workloads have proper resource limits.
This is not possible via RBAC.</p><h2 id=beyond-rbac>Beyond RBAC</h2><p>That is why Kubernetes has a pluggable mechanism for deploying additional validation for your resources.
These are called <a href=https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/>validating webhooks</a> which allow you to register a webhook that will be called by Kubernetes to check whether a given resource can be created/updated.</p><p>How this works is - you register a webhook that Kubernetes will call when objects are being interacted via (e.g. <code>CREATE</code> or <code>UPDATE</code> operation).
Kubernetes will send a request to the webhook, passing the object in the request body and it will expect to receive a response that should tell Kubernetes whether or not this resource should be created/updated.</p><p>UPCOMING: An article that describes in more detail how validating webhooks work and how to write your own.</p><p>You can write your own admission webhook from scratch or use <a href=https://github.com/open-policy-agent/gatekeeper>Gatekeeper</a> which allows you to deploy custom policies, written in <a href=https://www.openpolicyagent.org/docs/latest/policy-language/>Rego</a> and evaluated by <a href=https://www.openpolicyagent.org/>Open Policy Agent</a>.</p><h2 id=open-policy-agent>Open Policy Agent</h2><p><a href=https://www.openpolicyagent.org/>Open Policy Agent</a> is a general-purpose policy agent that evaluates JSON input against rules, written in Rego, and returns a JSON output based on the evaluation.</p><h2 id=rego>Rego</h2><p>Rego is a declarative query language that can be used to write policies about the data coming into the system.</p><p>A simple Rego rule that checks if the conference name of the input document is &ldquo;BSides&rdquo;:</p><pre tabindex=0><code class=language-rego data-lang=rego>package bsides

default allow = false

allow = true {
    input.conference.name = &#34;BSides&#34;
}
</code></pre><p>If you want to play with the examples in the Rego playground, use the links in the <code>Link</code> column.</p><table><thead><tr><th>Input</th><th>Output</th><th>Playground link</th></tr></thead><tbody><tr><td><code>{"conference":{"name": "BSides"}}</code></td><td><code>{"allow": true}</code></td><td><a href=https://play.openpolicyagent.org/p/OqvsvG5BU7>Link</a></td></tr><tr><td><code>{"conference":{"name": "SomethingElse"}}</code></td><td><code>{"allow": false}</code></td><td><a href=https://play.openpolicyagent.org/p/SzGf67ckQg>Link</a></td></tr></tbody></table><p>A bit more complex rule that checks if the conference name is &ldquo;BSides&rdquo; and the conference venue is &ldquo;UNWE&rdquo; and if not outputs a message:</p><pre tabindex=0><code class=language-rego data-lang=rego>package bsides

violations[{&#34;msg&#34;: msg}] {
    input.conference.name != &#34;BSides&#34;
    input.conference.venue != &#34;UNWE&#34;
    msg = sprintf(&#34;name and venue are wrong - [%s, %s]&#34;, [input.conference.name, input.conference.venue])
}
</code></pre><p>However, the message is only shown if both checks are true, e.g. it will not output anything if only one of the values is wrong:</p><table><thead><tr><th>Input</th><th>Output</th><th>Correct</th><th>Playground link</th></tr></thead><tbody><tr><td><code>{"conference":{"name": "BSides", "venue": "UNWE"}}</code></td><td><code>{"violations": []}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/wY3h6EN6Dj>Link</a></td></tr><tr><td><code>{"conference":{"name": "SomethingElse", "venue": "SomethingElse"}}</code></td><td><code>{"violations": [{"msg": "name and venue are wrong - [SomethingElse, SomethingElse]"}]}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/JeV5Yg2mlw>Link</a></td></tr><tr><td><code>{"conference":{"name": "SomethingElse", "venue": "UNWE"}}</code></td><td><code>{"violations": []}</code></td><td>❌</td><td><a href=https://play.openpolicyagent.org/p/ZPS6QPZZD7>Link</a></td></tr><tr><td><code>{"conference":{"name": "BSides", "venue": "SomethingElse"}}</code></td><td><code>{"violations": []}</code></td><td>❌</td><td><a href=https://play.openpolicyagent.org/p/Xo4jlfyFii>Link</a></td></tr></tbody></table><p>In this case, this is not what we want, we want to have an error message if at least one of the two values is wrong.</p><p>However, Rego rules work by just chaining the expressions in an <code>AND</code> statement.</p><p>That is why, if we want to achieve this result, we need to tweak the rule a bit:</p><pre tabindex=0><code class=language-rego data-lang=rego>package bsides

violations[{&#34;msg&#34;: msg}] {
    input.conference.name != &#34;BSides&#34;
    msg := &#34;name is wrong&#34;
}

violations[{&#34;msg&#34;: msg}] {
    input.conference.venue != &#34;UNWE&#34;
    msg := &#34;venue is wrong&#34;
}
</code></pre><table><thead><tr><th>Input</th><th>Output</th><th>Correct</th><th>Playground link</th></tr></thead><tbody><tr><td><code>{"conference":{"name": "BSides", "venue": "UNWE"}}</code></td><td><code>{"violations": []}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/WMxPOAnMqR>Link</a></td></tr><tr><td><code>{"conference":{"name": "SomethingElse", venue: "SomethingElse"}}</code></td><td><code>{"violations": [{"msg": "name is wrong"}, {"msg": "venue is wrong"}]}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/bOYYXRjkhY>Link</a></td></tr><tr><td><code>{"conference":{"name": "SomethingElse", venue: "UNWE"}}</code></td><td><code>{"violations": [{"msg": "name is wrong"}]}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/iVHjvE6C4c>Link</a></td></tr><tr><td><code>{"conference":{"name": "BSides", venue: "SomethingElse"}}</code></td><td><code>{"violations": [{"msg": "venue is wrong"}]}</code></td><td>✅</td><td><a href=https://play.openpolicyagent.org/p/UB8NwmJ5e4>Link</a></td></tr></tbody></table><p>This covers rules all possibilities and we have at least one error message if some of the values are wrong.</p><p><strong>NOTE:</strong> This is not a bug or a deficiency in Rego, this is just how Rego rules work and something we should be aware of when using the language.</p><h2 id=gatekeeper>Gatekeeper</h2><p>As said, Open Policy Agent is a general-purpose policy engine that has nothing to do with Kubernetes.</p><p>To use it with Kubernetes, we need an adapter that will be the bridge between OPA and Kubernetes.</p><p>That adapter is called <a href=https://github.com/open-policy-agent/gatekeeper>Gatekeeper</a>.
It serves as the bridge between Kubernetes and OPA.
It implements a Validating Webhook, allowing it to be called by Kubernetes to determine whether a resource can be created/updated.
Also, it provided the object data to the Rego policy so that when we are writing our policies we can expect to get the whole object data provided by Gatekeeper.</p><p>It also allows storing the policies as Custom Kubernetes objects (CRDs).
That way, our policies, and rules become first-class citizens of our Kubernetes cluster.</p><p>More about what CRDs are you can read here - <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/>https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/</a>.</p><h3 id=constrainttemplates>ConstraintTemplates</h3><p><code>ConstraintTemplates</code> are Kubernetes objects - Custom Resource Definitions (CRDs) that are installed with Gatekeeper.</p><p>They wrap a Rego policy and define input parameters for the policy.
This allows for a <code>ConstraintTemplates</code> to be reused with different parameters.</p><p>A sample <code>ConstraintTemplate</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>apiVersion</span>: templates.gatekeeper.sh/v1
</span></span><span style=display:flex><span><span style=color:#268bd2>kind</span>: ConstraintTemplate
</span></span><span style=display:flex><span><span style=color:#268bd2>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>name</span>: k8srequiredlabels
</span></span><span style=display:flex><span><span style=color:#268bd2>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>crd</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#268bd2>names</span>:
</span></span><span style=display:flex><span>        <span style=color:#268bd2>kind</span>: K8sRequiredLabels
</span></span><span style=display:flex><span>      <span style=color:#268bd2>validation</span>:
</span></span><span style=display:flex><span>        <span style=color:#586e75># Schema for the `parameters` field</span>
</span></span><span style=display:flex><span>        <span style=color:#268bd2>openAPIV3Schema</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>type</span>: object
</span></span><span style=display:flex><span>          <span style=color:#268bd2>properties</span>:
</span></span><span style=display:flex><span>            <span style=color:#268bd2>labels</span>:
</span></span><span style=display:flex><span>              <span style=color:#268bd2>type</span>: array
</span></span><span style=display:flex><span>              <span style=color:#268bd2>items</span>:
</span></span><span style=display:flex><span>                <span style=color:#268bd2>type</span>: string
</span></span><span style=display:flex><span>  <span style=color:#268bd2>targets</span>:
</span></span><span style=display:flex><span>    - <span style=color:#268bd2>target</span>: admission.k8s.gatekeeper.sh
</span></span><span style=display:flex><span>      <span style=color:#268bd2>rego</span>: |<span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>        package k8srequiredlabels
</span></span></span><span style=display:flex><span><span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>        violation[{&#34;msg&#34;: msg, &#34;details&#34;: {&#34;missing_labels&#34;: missing}}] {
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          provided := {label | input.review.object.metadata.labels[label]}
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          required := {label | label := input.parameters.labels[_]}
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          missing := required - provided
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          count(missing) &gt; 0
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          msg := sprintf(&#34;you must provide labels: %v&#34;, [missing])
</span></span></span><span style=display:flex><span><span style=color:#2aa198>        }</span>        
</span></span></code></pre></div><p>This <code>ConstraintTemplate</code> wraps a Rego policy that checks whether a given Kubernetes resource has a set of required labels.</p><p>The exact set is contained in the <code>input.parameters.labels</code> field.
The reason that we store the required labels in this parameter instead of hard-coding them into the policy is that this way we can reuse the <code>ConstraintTemplate</code> with another set of required labels.</p><p>We will see where this parameter comes from soon.</p><h3 id=constraint>Constraint</h3><p>After you apply the <code>ConstraintTemplate</code> from above, Gatekeeper will register a new CRD into your cluster.</p><p>The name of that CRD is in the <code>spec.crd.spec.names.kind</code> field of the <code>ConstraintTemplate</code>.
In our case, it&rsquo;s <code>K8sRequiredLabels</code>.</p><p>To start enforcing this policy we will need to create an instance of this CRD, in which we will specify when to invoke the rule and what are the required labels.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>apiVersion</span>: constraints.gatekeeper.sh/v1beta1
</span></span><span style=display:flex><span><span style=color:#268bd2>kind</span>: K8sRequiredLabels
</span></span><span style=display:flex><span><span style=color:#268bd2>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>name</span>: deployments-must-have-gk
</span></span><span style=display:flex><span><span style=color:#268bd2>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>match</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>kinds</span>:
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>apiGroups</span>: [<span style=color:#2aa198>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#268bd2>kinds</span>: [“Deployments&#34;]
</span></span><span style=display:flex><span>  <span style=color:#268bd2>parameters</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>labels</span>: [<span style=color:#2aa198>&#34;gatekeeper&#34;</span>]
</span></span></code></pre></div><p>This resource specifies that this policy must be invoked when <code>Deployments</code> are being interacted with.</p><p>It also specifies that the required labels are <code>["gatekeeper"]</code>.</p><p>Now, if we try to create a deployment, Gatekeeper will use OPA to check whether the deployment has the required labels.
If not, Gatekeeper will deny the creation of this resource, and Kubernetes will respect this decision, returning an error to the user.</p><h3 id=getting-our-hands-dirty>Getting our hands dirty</h3><p>Let&rsquo;s see all of this in practice.</p><p><strong>NOTE:</strong> All of the resources I create below can be found in <a href=https://github.com/asankov/securing-kubernetes-with-open-policy-agent>this GitHub repo</a>.
To follow the demo you can clone the repo and use the Kubernetes spec files or just reference them via their GitHub links.
Both ways are shown in the examples.</p><h4 id=installing-gatekeeper>Installing Gatekeeper</h4><p>First, we need to install Gatekeeper into our cluster.</p><p>To do that apply this Kubernetes resource:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml
</span></span></code></pre></div><p><strong>NOTE:</strong> This link is taken for the official docs at <a href=https://open-policy-agent.github.io/gatekeeper/website/docs/install/>https://open-policy-agent.github.io/gatekeeper/website/docs/install/</a>.
If it gets outdated and it does not work, consult the actual docs.</p><h4 id=creating-a-constrainttemplates>Creating a ConstraintTemplates</h4><p>Apply the <code>ConstraintTemplate</code> YAML:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f k8s/constraint-template.yaml
</span></span></code></pre></div><p>or if you haven&rsquo;t cloned the repo:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/asankov/securing-kubernetes-with-open-policy-agent/main/k8s/constraint-template.yaml
</span></span></code></pre></div><p>This should create the <code>ConstraintTemplate</code> and also register the <code>K8sRequiredLabels</code> CRD.</p><p>Check that by running:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get constrainttemplates.templates.gatekeeper.sh
</span></span><span style=display:flex><span>NAME                AGE
</span></span><span style=display:flex><span>k8srequiredlabels   119s
</span></span></code></pre></div><p>and</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get crds
</span></span><span style=display:flex><span>NAME                                                    CREATED AT
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>k8srequiredlabels.constraints.gatekeeper.sh             2022-04-09T20:49:22Z
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>You should see the <code>k8srequiredlabels</code> constraint template and CRD in the output of these commands.</p><h4 id=creating-a-constraint>Creating a Constraint</h4><p>To start enforcing this <code>ConstraintTemplate</code> create the actual <code>Constraint</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f k8s/constraint.yaml
</span></span></code></pre></div><p>or if you haven&rsquo;t cloned the repo:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/asankov/securing-kubernetes-with-open-policy-agent/main/k8s/constraint.yaml
</span></span></code></pre></div><p>This should create the <code>K8sRequiredLabels</code> resource.</p><p>Check that by running:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get k8srequiredlabels.constraints.gatekeeper.sh
</span></span><span style=display:flex><span>NAME                       AGE
</span></span><span style=display:flex><span>deployments-must-have-gk   8s
</span></span></code></pre></div><p>You should see the <code>deployments-must-have-gk</code> constraint output.</p><h4 id=creating-a-non-compliant-resource>Creating a non-compliant resource</h4><p>The moment of truth!
We have created our <code>ConstraintTemplate</code> and our <code>Constraint</code> so our security should be in place.
Let&rsquo;s try to create a Deployment that does not comply with this rule and see what happens.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f k8s/non-compliant-deployment.yaml
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/asankov/securing-kubernetes-with-open-policy-agent/main/k8s/non-compliant-deployment.yaml
</span></span></code></pre></div><p>In both cases the result should be:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f k8s/non-compliant-deployment.yaml
</span></span><span style=display:flex><span>Error from server <span style=color:#719e07>([</span>deployments-must-have-gk<span style=color:#719e07>]</span> you must provide labels: <span style=color:#719e07>{</span><span style=color:#2aa198>&#34;gatekeeper&#34;</span><span style=color:#719e07>})</span>: error when creating <span style=color:#2aa198>&#34;non-compliant-deployment.yaml&#34;</span>: admission webhook <span style=color:#2aa198>&#34;validation.gatekeeper.sh&#34;</span> denied the request: <span style=color:#719e07>[</span>deployments-must-have-gk<span style=color:#719e07>]</span> you must provide labels: <span style=color:#719e07>{</span><span style=color:#2aa198>&#34;gatekeeper&#34;</span><span style=color:#719e07>}</span>
</span></span></code></pre></div><p>Our deployment cannot be created, because it does not comply with our rule.</p><p>What happened in more detail was:</p><ul><li>we invoked <code>kubectl</code> to try to create the deployment</li><li><code>kubectl</code> parsed the <code>non-compliant-deployment.yaml</code> file, serialized it into JSON, and send a POST request to the Kube API server</li><li>the Kube API server parsed the request</li><li>it checked whether we have the necessary RBAC permission to perform this operation (we do)</li><li>it called all validating webhooks registered for this type of operation (<code>action:CREATE</code>, <code>resource:Deployment</code>)</li><li>one of these validating webhooks is <code>gatekeeper-validating-webhook-configuration</code> (the one coming from Gatekeeper)</li><li>once Kubernetes called Gatekeeper, Gatekeeper checked what constraint it had for this operation (<code>action:CREATE</code>, <code>resource:Deployment</code>)</li><li>the only and only constraint was <code>deployments-must-have-gk</code> (which has <code>k8srequiredlabels</code> for constraint template)</li><li>Gatekeeper called OPA with the policy from <code>k8srequiredlabels</code> constraint template, passing as input the deployment being created and the parameters from the <code>deployments-must-have-gk</code> constraint</li><li>OPA evaluated the policy and the input, giving as output <code>violations</code> array with one item</li><li>Gatekeeper got the output from OPA, determined that this resource cannot be created, and returned a response to the Kube API server that this operation is not allowed</li><li>the Kube API server aborted the operation and returned an error</li><li><code>kubectl</code> outputs the error on the screen</li></ul><h4 id=fixing-the-violation>Fixing the violation</h4><p>The output is clear on where we are wrong and what we need to correct to create this resource.
Let&rsquo;s do that.</p><p>We have the same deployment with the additional labels in <a href=k8s/compliant-deployment.yaml><code>compliant-deployment.yaml</code></a>.</p><p>Let&rsquo;s apply this file:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f k8s/compliant-deployment.yaml
</span></span></code></pre></div><p>or</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/asankov/securing-kubernetes-with-open-policy-agent/main/k8s/compliant-deployment.yaml
</span></span></code></pre></div><p>In both cases the result should be:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f k8s/compliant-deployment.yaml
</span></span><span style=display:flex><span>deployment.apps/non-compliant created
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>Build-in Kubernetes security is not good enough for organizations that want to enforce granular policies on their resources.</p><p>That is why Kubernetes has a pluggable mechanism for deploying additional validation for your resources.</p><p>This gets even easier when you add Open Policy Agent and Gatekeeper.</p><p>Gatekeeper provides all the plumbing, regarding the communication between Kubernetes and OPA. OPA provides a powerful policy agent that will evaluate your resources against rules written in the Rego language.</p><p>If you liked this article, you can follow me on <a href=https://twitter.com/a_sankov>Twitter</a> and <a href=https://www.linkedin.com/in/asankov/>LinkedIn</a> for more content like this.</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2022/01/29/different-ways-to-initialize-go-structs/ aria-label="Previous - Different Ways to Initialize Go structs" class="btn btn-primary"><span class=mr-1>←</span>Previous</a></li><a href=/blog/2022/05/15/demystifying-the-kubernetes-iceberg-part-1/ aria-label="Next - Demystifying the Kubernetes Iceberg: Part 1" class="btn btn-primary">Next<span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="py-5 row d-print-none bg-nord0"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=mailto:asankov96@gmail.com aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank rel=noopener href=https://twitter.com/a_sankov aria-label=Twitter><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/asankov aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel=noopener href=https://linkedin.com/in/asankov aria-label=LinkedIn><i class="fab fa-linkedin"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 Anton Sankov All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small><p class=mt-2><a href=/about/>About Me</a></p></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.1f7a9a77f4986d1b3c8c9d4e576bc7675ba7359139a0f97729bd28e9e2e1fd49.js integrity="sha256-H3qad/SYbRs8jJ1OV2vHZ1unNZE5oPl3Kb0o6eLh/Uk=" crossorigin=anonymous></script></body></html>